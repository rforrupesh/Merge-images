<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working GPS Map Camera</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#000;
    color:white;
}

#captureArea{
    max-width:500px;
    margin:auto;
}

.camera-container{
    position:relative;
}

video{
    width:100%;
    display:block;
}

.overlay{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    background:rgba(0,0,0,0.6);
    padding:10px;
    font-size:14px;
}

#map{
    height:220px;
}

.controls{
    text-align:center;
    padding:10px;
}

button{
    padding:10px 20px;
    margin:5px;
    border:none;
    background:#4CAF50;
    color:white;
    border-radius:5px;
    font-size:16px;
}
</style>
</head>

<body>

<div id="captureArea">

    <div class="camera-container">
        <div class="overlay">
            <div>Lat: <span id="lat">--</span></div>
            <div>Lon: <span id="lon">--</span></div>
            <div>Accuracy: <span id="accuracy">--</span></div>
            <div id="time">--</div>
            <div id="status"></div>
        </div>
        <video id="video" autoplay playsinline></video>
    </div>

    <div id="map"></div>

</div>

<div class="controls">
    <button onclick="startApp()">Start</button>
    <button onclick="capture()">Capture</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let map, marker, circle;

function startApp(){
    startCamera();
    startGPS();
    startClock();
}

// CAMERA (simplified for compatibility)
function startCamera(){
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream=>{
        document.getElementById("video").srcObject = stream;
        document.getElementById("status").innerText = "Camera Started";
    })
    .catch(err=>{
        document.getElementById("status").innerText = "Camera Error: " + err.message;
    });
}

// GPS (watchPosition = more reliable)
function startGPS(){

    if(!navigator.geolocation){
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.watchPosition(position=>{

        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        document.getElementById("lat").innerText = lat.toFixed(6);
        document.getElementById("lon").innerText = lon.toFixed(6);
        document.getElementById("accuracy").innerText = accuracy.toFixed(1) + " m";

        if(!map){
            map = L.map('map').setView([lat, lon], 18);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
                attribution:'Â© OpenStreetMap'
            }).addTo(map);
        }

        if(marker) map.removeLayer(marker);
        if(circle) map.removeLayer(circle);

        marker = L.marker([lat, lon]).addTo(map);

        circle = L.circle([lat, lon], {
            radius: accuracy,
            fillOpacity: 0.2
        }).addTo(map);

    },{
        enableHighAccuracy:true,
        maximumAge:0,
        timeout:15000
    });
}

// Clock
function startClock(){
    setInterval(()=>{
        document.getElementById("time").innerText =
            new Date().toLocaleString();
    },1000);
}

// Capture
function capture(){
    html2canvas(document.getElementById("captureArea"))
    .then(canvas=>{
        let link = document.createElement("a");
        link.download = "GPS_Camera.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}
</script>

</body>
</html>
